#!/bin/bash
set -e

goenv_path="$HOME/.goenv"
version_root="$goenv_path/root"
go_url="https://storage.googleapis.com/golang"

# Colors
red="\e[31m"
gre="\e[32m"
yel="\e[33m"
blu="\e[34m"
pup="\e[35m"
nei="\e[36m"
de="\e[39m"

function goenv() {
    declare -a modes 
    local modes=($@)

    usage() {
        echo " goenv command list:"
        echo ""
        echo "      help: display how to use goenv command."
        echo "       use: switches your go version."
        echo "      list: lists your go versions."
        echo "   install: install go."
        echo ""
    }

    help() {
        case $1 in
            use)
                echo -e "Usage: goenv use <installed_go_version>"
                echo ""
                echo -e " <installed_go_version> is the version of your installed go at $HOME/.goenv."
                echo -e " If you check your go versions, execute 'goenv list'."
                echo ""
                ;;
            list)
                echo -e "Usage: goenv list"
                ;;
            install)
                echo -e "Usage: goenv install <version>"
                echo ""
                echo -e " <version> is the version of go (e.g. go1.5.3)."
                echo ""
                ;;
            *)
                usage
        esac
    }

    install() {
        mkdir -p $version_root
        local version=$1
        local filename=${version}.linux-amd64.tar.gz
        echo -e "${gre}Starts to install ${version}. ($version_root/$version)${de}"
        if [[ $version != "" ]] ; then
            if [[ -d "$version_root/$version" ]] ; then
                echo -e "${yel}Warning: Already installed ${version}."
            else
                cd /tmp
                if [[ ! -f "${filename}" ]] ; then
                    curl -O -o -L $go_url/${version}.linux-amd64.tar.gz 
                fi
                tar zxf ${filename} 
                mv go $version_root/${version}
            fi
            echo -e "${gre}Succeed to install ${version}.${de}"
        else
            usage "install"
        fi
    }

    list() {
        echo `ls $version_root`
    }

    use() {
        if [[ $# -ne 1 ]] ; then
            echo -e "$red[ERROR] Wrong argument: $1${de}"
            help "use"
            return
        fi

        local version=$1
        if [[ -d "$version_root/${version}" ]] ; then 
            # remove symlink
            rm -f $GOROOT 
            ln -s $version_root/$version $GOROOT
            echo -e "${gre}switched go version."
            echo -n -e "${blu}"
            echo -e `go version`
            echo -n -e "${de}"
        else
            echo -e "$red[ERROR] Does not exist version ($HOME/.goenv): ${version}${de}"
            echo -e "your installed go versions:"
            list
        fi
    }

    case ${modes[0]} in
        help|install|use)
            ${modes[0]} ${modes[1]}
            return 
            ;;
        list)
            list
            return
            ;;
        *)
            usage
            return
            ;;
    esac
}

goenv $@
